<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Pend√™ncias - KSS MOTOS</title>
    <link rel="stylesheet" href="styles.css"> 
    <style>
        /* CSS Adicional para links de anexos m√∫ltiplos */
        .attachment-list {
            display: flex;
            flex-direction: column;
            gap: 5px; /* Espa√ßo entre os links */
        }
        .attachment-link {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.95em;
        }
        .attachment-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

    <div class="main-content">
        <header>
            <h1>Sistema de Pend√™ncias - KSS MOTOS</h1>
        </header>

        <div class="new-task-section">
            <input type="text" id="taskInput" placeholder="Pend√™ncia">
            <select id="cityInput">
				<option value="Geral">Geral</option>
				<option value="Amarante">Amarante</option>
				<option value="S√≠tio Novo">S√≠tio Novo</option>
				<option value="Graja√∫">Graja√∫</option>
                <option value="Barra do Corda">Barra do Corda</option>
                <option value="Balsas">Balsas</option>
                <option value="Presidente Dutra">Presidente Dutra</option>
				<option value="Pedreiras">Pedreiras</option>
				<option value="Cod√≥">Cod√≥</option>
				<option value="Bacabal">Bacabal</option>
				<option value="Cear√° & Baba√ßul√¢ndia">Cear√° & Baba√ßul√¢ndia</option>
                <option value="A√ßail√¢ndia">A√ßail√¢ndia</option>
            </select>
            <input type="text" id="requesterInput" placeholder="Solicitante">
            
            <input type="file" id="attachmentInput" name="attachments" accept="*/*" multiple> 

            <button onclick="addTask()">Adicionar Pend√™ncia</button>
        </div>

        <div class="cards">
            <div class="card" id="pending-count">
                <h2>0</h2>
                <p>Pend√™ncias</p>
            </div>
            <div class="card" id="completed-count">
                <h2>0</h2>
                <p>Conclu√≠das</p>
            </div>
            <div class="card">
                <h2><span id="time-display"></span></h2>
                <p>Hora atual:</p>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Pend√™ncia</th>
                    <th>Cidade</th>
                    <th>Solicitante</th>
                    <th>Data/Hora | Anexo(s)</th> <th>A√ß√£o</th>
                </tr>
            </thead>
            <tbody id="taskList">
            </tbody>
        </table>
    </div>

    <footer>
        <p>2025 ¬© Atalias L√¥-Am√≠</p>
        <div class="footer-links">
            <a href="https://github.com/AtaliasOliveira1/System-Pendencias">Github</a>
        </div>
    </footer>

    
    <div id="attachModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeAttachModal()">&times;</span>
            <h3>Anexar arquivo(s) √† Pend√™ncia: <span id="modalTaskName"></span></h3>
            
            <input type="file" id="modalAttachmentInput" accept="*/*" multiple>
            
            <button onclick="uploadAttachment()">Anexar</button>
            <p id="uploadStatus" style="color: green;"></p>
        </div>
    </div>

    <script>
        const taskList = document.getElementById("taskList");
        const taskInput = document.getElementById("taskInput");
        const cityInput = document.getElementById("cityInput");
        const requesterInput = document.getElementById("requesterInput");
        const attachmentInput = document.getElementById("attachmentInput");
        let pendingCount = 0;
        let completedCount = 0;

        const attachModal = document.getElementById('attachModal');
        const modalTaskNameSpan = document.getElementById('modalTaskName');
        const modalAttachmentInput = document.getElementById('modalAttachmentInput');
        const uploadStatus = document.getElementById('uploadStatus');
        let currentTaskToAttach = null; 

        document.addEventListener('DOMContentLoaded', loadTasks);

        function loadTasks() {
            fetch('/tasks')
                .then(response => response.json())
                .then(tasks => {
                    taskList.innerHTML = ''; 
                    pendingCount = 0;
                    completedCount = 0; 

                    tasks.forEach(task => {
                        if (!task.completed) {
                            addTaskToDOM(task);
                        } else {
                            completedCount++;
                        }
                    });
                    updateCounters();
                })
                .catch(err => console.error('Erro ao carregar tarefas:', err));
        }

        // ‚¨ÖÔ∏è MUDAN√áA: Lida com m√∫ltiplos arquivos
        function addTask() {
            const taskName = taskInput.value.trim();
            const cityName = cityInput.value.trim();
            const requesterName = requesterInput.value.trim();
            const attachmentFiles = attachmentInput.files; // √â uma FileList

            if (taskName && cityName && requesterName) {
                const formData = new FormData();
                formData.append('taskName', taskName);
                formData.append('cityName', cityName);
                formData.append('requesterName', requesterName);
                
                // ‚¨ÖÔ∏è MUDAN√áA: Loop para adicionar todos os arquivos
                if (attachmentFiles.length > 0) {
                    for (let i = 0; i < attachmentFiles.length; i++) {
                        // O nome do campo deve ser 'attachments' (plural)
                        formData.append('attachments', attachmentFiles[i]); 
                    }
                }

                fetch('/tasks-with-file', {
                    method: 'POST',
                    body: formData 
                })
                .then(response => response.json())
                .then(savedTask => {
                    loadTasks(); // Recarrega tudo para simplicidade
                    taskInput.value = "";
                    cityInput.value = "";
                    requesterInput.value = "";
                    attachmentInput.value = "";
                })
                .catch(err => console.error('Erro ao adicionar tarefa:', err));
            } else {
                alert("Por favor, preencha todos os campos de Pend√™ncia, Cidade e Solicitante.");
            }
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === "Enter") {
                addTask();
            }
        });
    
        function formatTimestamp(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const dateStr = date.toLocaleDateString('pt-BR');
            const timeStr = date.toLocaleTimeString('pt-BR');
            return `${dateStr} √†s ${timeStr}`;
        }

        // ‚¨ÖÔ∏è MUDAN√áA: Exibe m√∫ltiplos links de anexos
        function addTaskToDOM(task) {
            const row = document.createElement("tr");
            row.id = `task-row-${encodeURIComponent(task.name)}`;

            const taskCol = document.createElement("td");
            taskCol.textContent = task.name;

            const cityCol = document.createElement("td");
            cityCol.textContent = task.city;

            const requesterCol = document.createElement("td");
            requesterCol.textContent = task.requester;

            const infoCol = document.createElement("td");
            infoCol.classList.add("info-col");
            
            const timestampDiv = document.createElement("div");
            timestampDiv.textContent = formatTimestamp(task.timestamp);
            infoCol.appendChild(timestampDiv);
            
            // Container para os links de anexo
            const attachmentContainer = document.createElement("div");
            attachmentContainer.id = `attachment-container-${encodeURIComponent(task.name)}`;
            attachmentContainer.classList.add("attachment-list"); // Adiciona classe para estilo

            // ‚¨ÖÔ∏è MUDAN√áA: Loop no array de anexos
            if (task.attachments && task.attachments.length > 0) {
                task.attachments.forEach(file => {
                    const attachmentLink = document.createElement("a");
                    attachmentLink.href = file.path;
                    // Mostra o nome original do arquivo
                    attachmentLink.textContent = file.filename || "Baixar Anexo"; 
                    attachmentLink.target = "_blank";
                    attachmentLink.classList.add("attachment-link");
                    attachmentContainer.appendChild(attachmentLink);
                });
            } else {
                attachmentContainer.textContent = "Sem anexo";
            }
            infoCol.appendChild(attachmentContainer);
            
            const actionCol = document.createElement("td");
            
            const completeBtn = document.createElement("button");
            completeBtn.textContent = "‚úî";
            completeBtn.classList.add("complete-btn");
            completeBtn.title = "Concluir Pend√™ncia";
            completeBtn.onclick = () => toggleComplete(task, row);
            
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "‚úò";
            deleteBtn.classList.add("delete-btn");
            deleteBtn.title = "Excluir Pend√™ncia";
            deleteBtn.onclick = () => deleteTask(task, row);

            const attachBtn = document.createElement("button");
            attachBtn.textContent = "üìé";
            attachBtn.classList.add("attach-btn");
            attachBtn.title = "Anexar arquivo(s)";
            attachBtn.onclick = () => openAttachModal(task);


            actionCol.appendChild(completeBtn);
            actionCol.appendChild(deleteBtn);
            actionCol.appendChild(attachBtn);

            row.appendChild(taskCol);
            row.appendChild(cityCol);
            row.appendChild(requesterCol);
            row.appendChild(infoCol);
            row.appendChild(actionCol);
            taskList.appendChild(row);

            pendingCount++;
            updateCounters();
        }
        
        function deleteTask(task, row) {
            if (!confirm(`Tem certeza que deseja excluir a pend√™ncia "${task.name}"?`)) {
                return;
            }
            fetch(`/tasks/${encodeURIComponent(task.name)}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro ao deletar a tarefa');
                }
                loadTasks(); 
            })
            .catch(err => console.error(err));
        }

        function toggleComplete(task, row) {
            if (!confirm(`Marcar a pend√™ncia "${task.name}" como conclu√≠da?`)) {
                return;
            }

            // O spread operator (...) garante que o array 'attachments' seja preservado
            const updatedTask = {
                ...task, 
                completed: true 
            };

            fetch(`/tasks/${encodeURIComponent(task.name)}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedTask) 
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro ao atualizar a tarefa');
                }
                return response.json();
            })
            .then(() => {
                loadTasks(); 
            })
            .catch(err => console.error(err));
        }

        function updateCounters() {
            document.getElementById("pending-count").querySelector("h2").textContent = pendingCount;
            document.getElementById("completed-count").querySelector("h2").textContent = completedCount;
        }

        function updateTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById("time-display").textContent = `${hours}:${minutes}:${seconds}`;
        }
        setInterval(updateTime, 1000);
        updateTime();

        function clearCompletedTasks() {
            if (!confirm("Tem certeza que deseja limpar TODAS as pend√™ncias?")) {
                return;
            }
            fetch('/tasks/clear-all', {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro ao limpar todas as tarefas');
                }
                loadTasks(); 
            })
            .catch(err => console.error(err));
        }

        // Fun√ß√µes do Modal de Anexo
        function openAttachModal(task) {
            currentTaskToAttach = task;
            modalTaskNameSpan.textContent = task.name;
            modalAttachmentInput.value = ''; 
            uploadStatus.textContent = ''; 
            attachModal.style.display = 'flex'; 
        }

        function closeAttachModal() {
            attachModal.style.display = 'none'; 
            currentTaskToAttach = null;
        }

        // ‚¨ÖÔ∏è MUDAN√áA: Lida com m√∫ltiplos arquivos
        function uploadAttachment() {
            if (!currentTaskToAttach) {
                alert("Nenhuma pend√™ncia selecionada para anexar.");
                return;
            }

            const files = modalAttachmentInput.files; // √â uma FileList
            if (!files || files.length === 0) {
                uploadStatus.textContent = "Selecione um ou mais arquivos para anexar.";
                uploadStatus.style.color = "red";
                return;
            }

            uploadStatus.textContent = "Enviando...";
            uploadStatus.style.color = "orange";

            const formData = new FormData();
            // ‚¨ÖÔ∏è MUDAN√áA: Loop para adicionar todos os arquivos
            for (let i = 0; i < files.length; i++) {
                formData.append('attachments', files[i]); // Nome do campo 'attachments'
            }

            fetch(`/tasks/${encodeURIComponent(currentTaskToAttach.name)}/attach`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || 'Erro ao anexar arquivo(s)'); });
                }
                return response.json();
            })
            .then(updatedTask => {
                uploadStatus.textContent = "Anexo(s) enviado(s) com sucesso!";
                uploadStatus.style.color = "green";
                
                // ‚¨ÖÔ∏è MUDAN√áA: Recarrega a lista para exibir os novos anexos
                loadTasks(); 
                
                // Fecha o modal ap√≥s um sucesso
                setTimeout(closeAttachModal, 1000); 
            })
            .catch(err => {
                uploadStatus.textContent = `Erro: ${err.message}`;
                uploadStatus.style.color = "red";
                console.error('Erro ao fazer upload do anexo:', err);
            });
        }
    </script>
</body>
</html>