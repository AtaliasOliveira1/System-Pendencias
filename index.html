<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Pendências - KSS MOTOS</title>
    <link rel="stylesheet" href="styles.css"> 
    <style>
        /* CSS Adicional para links de anexos múltiplos */
        .attachment-list {
            display: flex;
            flex-direction: column;
            gap: 5px; /* Espaço entre os links */
        }
        .attachment-link {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.95em;
        }
        .attachment-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

    <div class="main-content">
        <header>
            <h1>Sistema de Pendências - KSS MOTOS</h1>
        </header>

        <div class="new-task-section">
            <input type="text" id="taskInput" placeholder="Pendência">
            <select id="cityInput">
				<option value="Geral">Geral</option>
				<option value="Amarante">Amarante</option>
				<option value="Sítio Novo">Sítio Novo</option>
				<option value="Grajaú">Grajaú</option>
                <option value="Barra do Corda">Barra do Corda</option>
                <option value="Balsas">Balsas</option>
                <option value="Presidente Dutra">Presidente Dutra</option>
				<option value="Pedreiras">Pedreiras</option>
				<option value="Codó">Codó</option>
				<option value="Bacabal">Bacabal</option>
				<option value="Ceará & Babaçulândia">Ceará & Babaçulândia</option>
                <option value="Açailândia">Açailândia</option>
            </select>
            <input type="text" id="requesterInput" placeholder="Solicitante">
            
            <input type="file" id="attachmentInput" name="attachments" accept="*/*" multiple> 

            <button onclick="addTask()">Adicionar Pendência</button>
        </div>

        <div class="cards">
            <div class="card" id="pending-count">
                <h2><span id="taskCounter">0</span></h2>
                <p>Pendências</p>
            </div>
            <div class="card" id="completed-count">
                <h2><span id="completedCounter">0</span></h2>
                <p>Concluídas</p>
            </div>
            <div class="card">
                <h2><span id="time-display"></span></h2>
                <p>Hora atual:</p>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Pendência</th>
                    <th>Cidade</th>
                    <th>Solicitante</th>
                    <th>Data/Hora | Anexo(s)</th> <th>Ação</th>
                </tr>
            </thead>
            <tbody id="taskList">
            </tbody>
        </table>
    </div>

    
    <div id="attachModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeAttachModal()">&times;</span>
            <h3>Anexar arquivo(s) à Pendência: <span id="modalTaskName"></span></h3>
            
            <input type="file" id="modalAttachmentInput" accept="*/*" multiple>
            
            <button onclick="uploadAttachment()">Anexar</button>
            <p id="uploadStatus" style="color: green;"></p>
        </div>
    </div>

    <div id="viewModal" class="modal">
        <div class="modal-content file-viewer-content">
            <span class="close-button" onclick="closeViewModal()">&times;</span>
            <h3 id="viewFileName">Visualizando Arquivo</h3>
            
            <iframe id="fileViewerFrame" frameborder="0" style="width: 100%; height: 80%; border: none;"></iframe>
            
            <div class="modal-actions">
                <a id="downloadButton" href="#" download class="download-btn">Baixar Arquivo</a>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content confirmation-content">
            <span class="close-button" onclick="closeConfirmModal()">&times;</span>
            <h3 id="confirmationTitle"></h3>
            <p id="confirmationMessage"></p>
            
            <div class="confirm-actions">
                <button id="confirmActionBtn" onclick="handleConfirmation()">Confirmar</button>
                <button class="cancel-btn" onclick="closeConfirmModal()">Cancelar</button>
            </div>
        </div>
    </div>


    <footer>
        <p>2025 © Atalias Lô-Amí</p>
        <div class="footer-links">
            <a href="https://github.com/AtaliasOliveira1/System-Pendencias">Github</a>
        </div>
    </footer>


    <script src="/socket.io/socket.io.js"></script>
    
    <script>
        const taskList = document.getElementById("taskList");
        const taskInput = document.getElementById("taskInput");
        const cityInput = document.getElementById("cityInput");
        const requesterInput = document.getElementById("requesterInput");
        const attachmentInput = document.getElementById("attachmentInput");
        
        const taskCounter = document.getElementById('taskCounter');
        const completedCounter = document.getElementById('completedCounter');

        let pendingCount = 0;
        let completedCount = 0;

        const attachModal = document.getElementById('attachModal');
        const modalTaskNameSpan = document.getElementById('modalTaskName');
        const modalAttachmentInput = document.getElementById('modalAttachmentInput');
        const uploadStatus = document.getElementById('uploadStatus');
        let currentTaskToAttach = null; 
        
        // VARIÁVEIS PARA O MODAL DE VISUALIZAÇÃO
        const viewModal = document.getElementById('viewModal');
        const fileViewerFrame = document.getElementById('fileViewerFrame');
        const viewFileName = document.getElementById('viewFileName');
        const downloadButton = document.getElementById('downloadButton');
        const fileViewerContent = document.querySelector('.modal-content.file-viewer-content');
        
        // NOVO: VARIÁVEIS PARA O MODAL DE CONFIRMAÇÃO
        const confirmModal = document.getElementById('confirmModal');
        const confirmationTitle = document.getElementById('confirmationTitle');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmActionBtn = document.getElementById('confirmActionBtn');
        let pendingAction = null; // Armazena a ação a ser executada ('complete' ou 'delete')
        let pendingTask = null;    // Armazena a tarefa envolvida na ação


        // ----------------------------------------------------
        // Lógica do Socket.IO para Tempo Real
        // ----------------------------------------------------
        const socket = io(); 

        // Escuta por eventos de mudança e recarrega a lista
        socket.on('task_created', () => loadTasks()); 
        socket.on('task_deleted', () => loadTasks());
        socket.on('task_updated', () => loadTasks()); 
        socket.on('tasks_cleared', () => loadTasks());
        // ----------------------------------------------------

        document.addEventListener('DOMContentLoaded', loadTasks);

        
        function loadTasks() {
            fetch('/tasks')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao carregar as pendências');
                    }
                    return response.json();
                })
                .then(tasks => {
                    taskList.innerHTML = ''; 
                    pendingCount = 0;
                    completedCount = 0; 
                    
                    // Ordena: Novas pendências no topo
                    tasks.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));


                    tasks.forEach(task => {
                        // FILTRO: SÓ exibe se NÃO estiver concluída
                        if (!task.completed) {
                            addTaskToDOM(task); 
                            pendingCount++;
                        } else {
                            // Conta as concluídas, mas NÃO exibe
                            completedCount++;
                        }
                    });
                    
                    updateCounters();
                })
                .catch(err => {
                    console.error('Erro ao carregar tarefas:', err);
                    taskList.innerHTML = `<tr><td colspan="5" style="text-align: center; color: var(--danger-color);">Erro ao carregar as pendências.</td></tr>`;
                });
        }

        function addTask() {
            const taskName = taskInput.value.trim();
            const cityName = cityInput.value.trim();
            const requesterName = requesterInput.value.trim();
            const attachmentFiles = attachmentInput.files;

            if (!taskName || !cityName || !requesterName) {
                alert("Por favor, preencha Pendência, Cidade e Solicitante.");
                return;
            }

            const formData = new FormData();
            formData.append('taskName', taskName);
            formData.append('cityName', cityName);
            formData.append('requesterName', requesterName);
            
            for (let i = 0; i < attachmentFiles.length; i++) {
                formData.append('attachments', attachmentFiles[i]); 
            }

            fetch('/tasks-with-file', {
                method: 'POST',
                body: formData 
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || 'Erro ao adicionar a pendência'); });
                }
                return response.json();
            })
            .then(savedTask => {
                taskInput.value = "";
                cityInput.value = "Geral"; 
                requesterInput.value = "";
                attachmentInput.value = "";
            })
            .catch(err => {
                console.error('Erro ao adicionar tarefa:', err);
                alert(`Erro ao adicionar pendência: ${err.message}`);
            });
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === "Enter" && document.activeElement !== attachmentInput && document.activeElement !== modalAttachmentInput) {
                addTask();
            }
        });
    
        function formatTimestamp(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const dateStr = date.toLocaleDateString('pt-BR');
            const timeStr = date.toLocaleTimeString('pt-BR');
            return `${dateStr} às ${timeStr}`;
        }

        function addTaskToDOM(task) {
            // A função só adiciona tarefas PENDENTES (graças ao loadTasks)
            if (task.completed) return; 
            
            const row = document.createElement("tr");
            row.id = `task-row-${encodeURIComponent(task.name)}`;

            const taskCol = document.createElement("td");
            taskCol.textContent = task.name;

            const cityCol = document.createElement("td");
            cityCol.textContent = task.city;

            const requesterCol = document.createElement("td");
            requesterCol.textContent = task.requester;

            const infoCol = document.createElement("td");
            infoCol.classList.add("info-col");
            
            const timestampDiv = document.createElement("div");
            timestampDiv.textContent = formatTimestamp(task.timestamp);
            infoCol.appendChild(timestampDiv);
            
            const attachmentContainer = document.createElement("div");
            attachmentContainer.id = `attachment-container-${encodeURIComponent(task.name)}`;
            attachmentContainer.classList.add("attachment-list");

            if (task.attachments && task.attachments.length > 0) {
                task.attachments.forEach(file => {
                    const attachmentLink = document.createElement("a");
                    // MUDANÇA: Remove target="_blank" e o href padrão
                    attachmentLink.href = "#"; 
                    attachmentLink.textContent = file.filename || "Baixar Anexo"; 
                    attachmentLink.classList.add("attachment-link");
                    // MUDANÇA: Adiciona a função para abrir o modal no clique
                    attachmentLink.onclick = (e) => {
                        e.preventDefault(); 
                        openViewModal(file.path, file.filename);
                    };
                    attachmentContainer.appendChild(attachmentLink);
                });
            } else {
                attachmentContainer.textContent = "Sem anexo";
            }
            infoCol.appendChild(attachmentContainer);
            
            const actionCol = document.createElement("td");
            
            // Botão Concluir
            const completeBtn = document.createElement("button");
            completeBtn.textContent = "✔"; 
            completeBtn.classList.add("complete-btn");
            completeBtn.title = "Concluir Pendência";
            
            // Ação de conclusão: AGORA ABRE O MODAL
            completeBtn.onclick = () => openConfirmModal('complete', task);
            
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "✘";
            deleteBtn.classList.add("delete-btn");
            deleteBtn.title = "Excluir Pendência";
            // Ação de exclusão: AGORA ABRE O MODAL
            deleteBtn.onclick = () => openConfirmModal('delete', task);

            const attachBtn = document.createElement("button");
            attachBtn.textContent = "Anexar";
            attachBtn.classList.add("attach-btn");
            attachBtn.title = "Anexar arquivo(s)";
            attachBtn.onclick = () => openAttachModal(task);


            actionCol.appendChild(completeBtn);
            actionCol.appendChild(deleteBtn);
            actionCol.appendChild(attachBtn);

            row.appendChild(taskCol);
            row.appendChild(cityCol);
            row.appendChild(requesterCol);
            row.appendChild(infoCol);
            row.appendChild(actionCol);
            taskList.appendChild(row);
        }
        
        // ----------------------------------------------------
        // Funções de Ação (executadas APÓS a confirmação)
        // ----------------------------------------------------

        function executeDeleteTask(task) {
            fetch(`/tasks/${encodeURIComponent(task.name)}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok && response.status !== 204) {
                    throw new Error('Erro ao deletar a tarefa');
                }
                // O Socket.IO se encarregará de recarregar a lista
            })
            .catch(err => console.error(err));
        }

        // Função para sempre marcar como TRUE (concluída)
        function executeToggleComplete(task) {
            const newStatus = true; 
            
            const updatedTask = {
                completed: newStatus 
            };

            fetch(`/tasks/${encodeURIComponent(task.name)}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedTask) 
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro ao atualizar a tarefa');
                }
                return response.json();
            })
            .then(() => {
                // O Socket.IO se encarregará de recarregar a lista e remover a linha concluída
            })
            .catch(err => console.error(err));
        }

        // ----------------------------------------------------
        // Lógica do Novo Modal de Confirmação
        // ----------------------------------------------------
        
        function openConfirmModal(actionType, task) {
            pendingAction = actionType;
            pendingTask = task;

            if (actionType === 'complete') {
                confirmationTitle.textContent = "CONFIRMAR CONCLUSÃO";
                confirmationMessage.innerHTML = `Tem certeza que deseja marcar a pendência **"${task.name}"** como CONCLUÍDA?`;
                confirmActionBtn.textContent = "CONCLUIR";
                confirmActionBtn.className = 'confirm-btn complete-action';
                
            } else if (actionType === 'delete') {
                confirmationTitle.textContent = "CONFIRMAR EXCLUSÃO";
                confirmationMessage.innerHTML = `**ATENÇÃO!** Você está prestes a excluir a pendência **"${task.name}"**. Esta ação é irreversível.`;
                confirmActionBtn.textContent = "EXCLUIR";
                confirmActionBtn.className = 'confirm-btn delete-action';
            }
            
            confirmModal.style.display = 'flex';
        }

        function closeConfirmModal() {
            confirmModal.style.display = 'none';
            pendingAction = null;
            pendingTask = null;
        }
        
        function handleConfirmation() {
            if (!pendingAction || !pendingTask) {
                closeConfirmModal();
                return;
            }

            // Executa a função correspondente
            if (pendingAction === 'complete') {
                executeToggleComplete(pendingTask);
            } else if (pendingAction === 'delete') {
                executeDeleteTask(pendingTask);
            }

            closeConfirmModal();
        }

        // ----------------------------------------------------
        // Lógica dos Modais Anexo e Visualização
        // ----------------------------------------------------

        function openAttachModal(task) {
            currentTaskToAttach = task;
            modalTaskNameSpan.textContent = task.name;
            modalAttachmentInput.value = ''; 
            uploadStatus.textContent = ''; 
            attachModal.style.display = 'flex'; 
        }

        function closeAttachModal() {
            attachModal.style.display = 'none'; 
            currentTaskToAttach = null;
        }

        function uploadAttachment() {
            if (!currentTaskToAttach) {
                alert("Nenhuma pendência selecionada para anexar.");
                return;
            }

            const files = modalAttachmentInput.files;
            if (!files || files.length === 0) {
                uploadStatus.textContent = "Selecione um ou mais arquivos para anexar.";
                uploadStatus.style.color = "red";
                return;
            }

            uploadStatus.textContent = "Enviando...";
            uploadStatus.style.color = "orange";

            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('attachments', files[i]);
            }

            fetch(`/tasks/${encodeURIComponent(currentTaskToAttach.name)}/attach`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || 'Erro ao anexar arquivo(s)'); });
                }
                return response.json();
            })
            .then(updatedTask => {
                uploadStatus.textContent = "Anexo(s) enviado(s) com sucesso!";
                uploadStatus.style.color = "green";
                
                // O Socket.IO se encarregará de recarregar a lista
                
                setTimeout(closeAttachModal, 1000); 
            })
            .catch(err => {
                uploadStatus.textContent = `Erro: ${err.message}`;
                uploadStatus.style.color = "red";
                console.error('Erro ao fazer upload do anexo:', err);
            });
        }
        
        function openViewModal(filePath, fileName) {
            viewFileName.textContent = fileName;
            
            const extension = fileName.split('.').pop().toLowerCase();
            const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(extension);
            
            downloadButton.href = filePath;
            downloadButton.download = fileName; 

            fileViewerFrame.style.display = 'none'; 
            
            if (isImage) {
                let existingImg = document.getElementById('viewerImage');
                if (existingImg) {
                    existingImg.remove();
                }

                const img = document.createElement('img');
                img.id = 'viewerImage';
                img.src = filePath;
                img.alt = fileName;
                img.className = 'viewer-image'; 
                
                const modalContent = document.querySelector('.modal-content.file-viewer-content');
                const modalActions = document.querySelector('.modal-actions');
                modalContent.insertBefore(img, modalActions);
                
            } else {
                let existingImg = document.getElementById('viewerImage');
                if (existingImg) {
                    existingImg.remove();
                }
                
                fileViewerFrame.style.display = 'block'; 
                fileViewerFrame.src = filePath; 
            }

            viewModal.style.display = 'flex'; 
        }

        function closeViewModal() {
            viewModal.style.display = 'none';
            
            fileViewerFrame.src = ''; 
            fileViewerFrame.style.display = 'block'; 
            
            let existingImg = document.getElementById('viewerImage');
            if (existingImg) {
                existingImg.remove();
            }
        }
        
        function updateCounters() {
            taskCounter.textContent = pendingCount;
            completedCounter.textContent = completedCount;
        }

        function updateTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById("time-display").textContent = `${hours}:${minutes}:${seconds}`;
        }
        setInterval(updateTime, 1000);
        updateTime();

        function clearCompletedTasks() {
            // Mantendo o confirm() nativo aqui. Mude para openConfirmModal se desejar customizá-lo também.
            if (!confirm("Tem certeza que deseja limpar TODAS as pendências?")) {
                return;
            }
            fetch('/tasks/clear-all', {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro ao limpar todas as tarefas');
                }
                // O Socket.IO se encarregará de recarregar a lista
            })
            .catch(err => console.error(err));
        }

    </script>
</body>
</html>